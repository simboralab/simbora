{% extends "core/page/base_core.html" %}


{% load static %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'eventos/css/events-created.css' %}">
    <link rel="stylesheet" href="{% static 'eventos/css/visualizar-evento.css' %}">
{% endblock extra_head %}
{% block title %}Meus eventos - Simbora{% endblock title %}


{% block content %}

{% csrf_token %}

<main class="events-created-main">
    <div>
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">Meus eventos</h1>
                <p class="page-subtitle">Gerenciamento</p>
            </div>
            <a href="{% url 'eventos:criar_evento' %}" class="btn-create-event">
                <span class="material-symbols-rounded">add</span>
                Criar Evento
            </a>
        </div>
        
        <nav class="filter-tabs">
            <div>
                <a href="?filtro=all" class="filter-tab {% if filtro_ativo == 'all' %}active{% endif %}">Todos</a>
                <a href="?filtro=created" class="filter-tab {% if filtro_ativo == 'created' %}active{% endif %}">Criados</a>
                <a href="?filtro=enrolled" class="filter-tab {% if filtro_ativo == 'enrolled' %}active{% endif %}">Inscrito</a>
                <a href="?filtro=cancelled" class="filter-tab {% if filtro_ativo == 'cancelled' %}active{% endif %}">Cancelado</a>
                <a href="?filtro=completed" class="filter-tab {% if filtro_ativo == 'completed' %}active{% endif %}">Concluído</a>
            </div>
        </nav>
        
        <section class="events-section">
            {% for item in eventos_com_info %}
                {% with evento=item.evento %}
                <article class="event-card" data-status="{% if evento.status == 'ATIVO' %}active{% elif evento.status == 'FINALIZADO' %}completed{% elif evento.status == 'CANCELADO' %}cancelled{% else %}active{% endif %}" data-categories="{% if evento.organizador and evento.organizador.usuario == request.user %}created{% else %}enrolled{% endif %}">
                    <div class="event-badges-top">
                        <span class="status-badge {% if evento.status == 'ATIVO' %}status-active{% elif evento.status == 'FINALIZADO' %}status-completed{% elif evento.status == 'CANCELADO' %}status-cancelled{% else %}status-active{% endif %}">
                            <span class="material-symbols-rounded">{% if evento.status == 'ATIVO' %}check_circle{% elif evento.status == 'CANCELADO' %}event_busy{% else %}task_alt{% endif %}</span>
                            {{ evento.get_status_display|title }}
                        </span>
                        {% if evento.organizador and evento.organizador.usuario == request.user %}
                            <span class="creator-badge">
                                <span class="material-symbols-rounded">workspace_premium</span> Host
                            </span>
                        {% elif item.usuario_inscrito %}
                            <span class="participation-badge enrolled">
                                <span class="material-symbols-rounded">person_check</span>
                                Inscrito
                            </span>
                        {% elif item.usuario_cancelado %}
                            <span class="participation-badge withdrawn">
                                <span class="material-symbols-rounded">person_off</span>
                                Cancelado
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="event-card-wrapper">
                        <div class="event-image-container">
                            <div class="event-image" style="background-image: url('{% if evento.foto %}{{ evento.foto.url }}{% elif evento.foto_url %}{{ evento.foto_url }}{% else %}https://via.placeholder.com/600x400/6366f1/ffffff?text=Sem+Imagem{% endif %}');"></div>
                            {% comment %}
                            <div class="event-tags-overlay">
                                {% for tag in evento.tags.all %}
                                    <span class="tag">{{ tag.nome }}</span>
                                {% endfor %}
                            </div>
                            {% endcomment %}
                        </div>
                        
                        <div class="event-content-wrapper">
                            <div class="event-header-info">
                                <h3 class="event-name">{{ evento.nome_evento }}</h3>
                            </div>
                            
                            <div class="event-meta">
                                <div class="event-meta-row">
                                    <div class="event-meta-item">
                                        <span class="material-symbols-rounded">calendar_today</span>
                                        <span>{{ evento.data_inicio|date:"D d, F - H:i" }}</span>
                                    </div>
                                    <div class="event-meta-item">
                                        <span class="material-symbols-rounded">location_on</span>
                                        <span>{% if evento.endereco %}{{ evento.endereco }}{% elif evento.local_encontro %}{{ evento.local_encontro }}{% else %}Local a definir{% endif %}</span>
                                    </div>
                                </div>
                                <div class="event-meta-item participants-item">
                                    <span class="material-symbols-rounded">group</span>
                                    <span class="participants-count">
                                        <strong>{{ item.total_participantes }}</strong> 
                                        / <strong class="total">{% if evento.maximo_participantes %}{{ evento.maximo_participantes }}{% else %}∞{% endif %}</strong> Participantes
                                    </span>
                                </div>
                            </div>
                            
                            <div class="event-actions">
                                {% if evento.organizador and evento.organizador.usuario == request.user %}
                                    {% if evento.status != 'FINALIZADO' %}
                                        <a href="{% url 'eventos:editar_evento' evento.pk %}" class="action-btn">
                                            <span class="material-symbols-rounded">edit</span> Editar
                                        </a>
                                    {% else %}
                                        <a href="{% url 'eventos:visualizar_evento' evento.pk %}" class="action-btn">
                                            <span class="material-symbols-rounded">visibility</span> Detalhes
                                        </a>
                                        <a href="#" class="action-btn">
                                            <span class="material-symbols-rounded">bar_chart</span> Estatísticas
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <a href="{% url 'eventos:visualizar_evento' evento.pk %}" class="action-btn">
                                        <span class="material-symbols-rounded">visibility</span> Detalhes
                                    </a>
                                {% endif %}
                                <a href="{% url 'eventos:participantes_evento' evento.pk %}" class="action-btn">
                                    <span class="material-symbols-rounded">group</span> Participantes
                                </a>
                                {% if evento.status == 'FINALIZADO' %}
                                    <a href="#" class="action-btn">
                                        <span class="material-symbols-rounded">star</span> Avaliar
                                    </a>
                                {% endif %}
                                {% if evento.status == 'ATIVO' and item.usuario_inscrito %}
                                    {% if not evento.organizador or evento.organizador.usuario != request.user %}
                                        <button type="button" class="action-btn btn-sair-evento" data-event-id="{{ evento.pk }}" data-event-name="{{ evento.nome_evento }}">
                                            <span class="material-symbols-rounded">close</span> Sair
                                        </button>
                                    {% endif %}
                                {% endif %}
                                {% if evento.organizador and evento.organizador.usuario == request.user and evento.status != 'FINALIZADO' and evento.status != 'CANCELADO' %}
                                    <button type="button" class="action-btn btn-cancelar-evento" data-event-id="{{ evento.pk }}" data-event-name="{{ evento.nome_evento }}">
                                        <span class="material-symbols-rounded">close</span> Cancelar
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </article>
                {% endwith %}
            {% empty %}
                <p class="no-events">Você ainda não tem eventos. <a href="{% url 'eventos:criar_evento' %}">Crie o primeiro!</a></p>
            {% endfor %}
        </section>
    </div>
</main>

<!-- Modal de Confirmação para Sair do Evento -->
<div id="modal-sair-evento" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="material-symbols-rounded modal-icon" style="color: var(--laranja);">warning</span>
            <h2>Confirmar Saída do Evento</h2>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja sair deste evento? Você perderá sua vaga e não receberá mais atualizações sobre ele.</p>
        </div>
        <div class="modal-actions">
            <button class="btn-modal-close" onclick="fecharModalSair()">
                <span class="material-symbols-rounded">close</span>
                Cancelar
            </button>
            <button class="btn-modal-whatsapp" id="btn-confirmar-sair" style="background-color: var(--laranja);">
                <span class="material-symbols-rounded">check</span>
                Sair do evento
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Cancelar Evento -->
<div id="modal-cancelar-evento" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="material-symbols-rounded modal-icon" style="color: #dc3545;">warning</span>
            <h2>Confirmar Cancelamento do Evento</h2>
        </div>
        <div class="modal-body">
            <p id="modal-cancelar-mensagem">Tem certeza que deseja cancelar este evento? Esta ação não pode ser desfeita e todos os participantes serão notificados.</p>
        </div>
        <div class="modal-actions">
            <button class="btn-modal-close" onclick="fecharModalCancelar()">
                <span class="material-symbols-rounded">close</span>
                Não cancelar
            </button>
            <button class="btn-modal-whatsapp" id="btn-confirmar-cancelar" style="background-color: #dc3545;">
                <span class="material-symbols-rounded">check</span>
                Sim, cancelar evento
            </button>
        </div>
    </div>
</div>

<!-- Footer original aqui -->
{% endblock %}

{% block extra_js %}
    <script src="{% static 'eventos/js/action-my-event.js' %}"></script>
    <script>
        // Verificar se o modal existe quando o script carrega
        console.log('Script carregado. Verificando modal...');
        setTimeout(function() {
            const modalCheck = document.getElementById('modal-sair-evento');
            console.log('Modal verificado no início:', modalCheck);
            if (!modalCheck) {
                console.warn('ATENÇÃO: Modal não encontrado no início do script!');
            }
        }, 100);
        
        // Função para mostrar notificação (se não existir)
        if (typeof showNotification === 'undefined') {
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <span class="material-symbols-rounded">
                        ${type === 'success' ? 'check_circle' : 'info'}
                    </span>
                    <span>${message}</span>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? 'var(--verde-limao)' : 'var(--azul-principal)'};
                    color: ${type === 'success' ? 'var(--azul-principal)' : 'var(--branco)'};
                    padding: 16px 24px;
                    border-radius: 50px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-family: var(--font-body);
                    font-size: 0.9375rem;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
            
            // Adicionar animações CSS
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Variáveis globais para o modal
        window.eventoIdParaSair = null;
        window.eventoNomeParaSair = null;
        
        // Função para abrir modal de sair (global)
        window.abrirModalSair = function(eventId, eventName) {
            console.log('abrirModalSair chamada com:', eventId, eventName);
            window.eventoIdParaSair = eventId;
            window.eventoNomeParaSair = eventName;
            
            // Aguardar um pouco para garantir que o DOM está pronto
            setTimeout(function() {
                const modal = document.getElementById('modal-sair-evento');
                console.log('Modal encontrado:', modal);
                console.log('Todos os modais na página:', document.querySelectorAll('.modal').length);
                
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.classList.add('show');
                    console.log('Modal aberto!');
                } else {
                    console.error('Modal não encontrado! Tentando novamente...');
                    // Tentar novamente após um delay maior
                    setTimeout(function() {
                        const modalRetry = document.getElementById('modal-sair-evento');
                        if (modalRetry) {
                            modalRetry.style.display = 'flex';
                            modalRetry.style.visibility = 'visible';
                            modalRetry.style.opacity = '1';
                            modalRetry.classList.add('show');
                            console.log('Modal aberto na segunda tentativa!');
                        } else {
                            console.error('Modal ainda não encontrado após segunda tentativa!');
                            alert('Erro: Modal não encontrado. Recarregue a página.');
                        }
                    }, 200);
                }
            }, 50);
        };
        
        // Função para fechar modal de sair (global)
        window.fecharModalSair = function() {
            const modal = document.getElementById('modal-sair-evento');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.classList.remove('show');
            }
            window.eventoIdParaSair = null;
            window.eventoNomeParaSair = null;
        };
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-sair-evento');
            if (modal && event.target === modal) {
                window.fecharModalSair();
            }
        });
        
        // Função para inicializar listeners
        function inicializarBotoesSair() {
            console.log('Inicializando botões Sair...');
            const botoesSair = document.querySelectorAll('.btn-sair-evento');
            console.log('Botões encontrados:', botoesSair.length);
            
            botoesSair.forEach((btn, index) => {
                console.log(`Anexando listener ao botão ${index}:`, btn);
                // Remove listener anterior se existir
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão Sair clicado!', this);
                    const eventId = this.getAttribute('data-event-id');
                    const eventName = this.getAttribute('data-event-name');
                    console.log('Event ID:', eventId, 'Event Name:', eventName);
                    if (window.abrirModalSair) {
                        window.abrirModalSair(eventId, eventName);
                    } else {
                        console.error('Função abrirModalSair não encontrada!');
                        alert('Erro: Função não encontrada. Recarregue a página.');
                    }
                });
            });
        }
        
        // Event listeners para botões "Sair"
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarBotoesSair);
        } else {
            // DOM já carregado
            inicializarBotoesSair();
        }
        
        // Função para inicializar botão de confirmar saída
        function inicializarBotaoConfirmarSair() {
            // Botão de confirmar saída
            const btnConfirmarSair = document.getElementById('btn-confirmar-sair');
            console.log('Botão confirmar sair encontrado:', btnConfirmarSair);
            if (btnConfirmarSair) {
                // Remove listener anterior se existir
                const newBtn = btnConfirmarSair.cloneNode(true);
                btnConfirmarSair.parentNode.replaceChild(newBtn, btnConfirmarSair);
                
                newBtn.addEventListener('click', function() {
                    if (!window.eventoIdParaSair) {
                        console.error('Evento ID não definido!');
                        return;
                    }
                    
                    // Obter CSRF token
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     document.cookie.match(/csrftoken=([^;]+)/)?.[1];
                    
                    if (!csrftoken) {
                        alert('Erro: Token de segurança não encontrado. Recarregue a página.');
                        return;
                    }
                    
                    // Fazer requisição AJAX
                    console.log('Fazendo requisição para sair do evento:', window.eventoIdParaSair);
                    fetch(`/eventos/sair/${window.eventoIdParaSair}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({})
                    })
                    .then(async response => {
                        const responseText = await response.text();
                        let data;
                        try {
                            data = JSON.parse(responseText);
                        } catch (e) {
                            data = { success: false, error: 'Resposta inválida do servidor' };
                        }
                        
                        if (!response.ok || !data.success) {
                            throw new Error(data.error || data.message || 'Erro ao sair do evento');
                        }
                        return data;
                    })
                    .then(data => {
                        console.log('Sucesso ao sair do evento:', data);
                        // Fechar modal
                        window.fecharModalSair();
                        
                        // Mostrar notificação de sucesso
                        if (typeof showNotification === 'function') {
                            showNotification('Você saiu do evento com sucesso!', 'success');
                        } else {
                            alert('Você saiu do evento com sucesso!');
                        }
                        
                        // Recarregar a página após um pequeno delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Erro ao sair do evento:', error);
                        alert('Erro ao sair do evento: ' + error.message);
                    });
                });
            }
        }
        
        // Event listeners para botões "Sair"
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                inicializarBotoesSair();
                inicializarBotaoConfirmarSair();
            });
        } else {
            // DOM já carregado
            inicializarBotoesSair();
            inicializarBotaoConfirmarSair();
        }
        
        // Também tenta após um pequeno delay para garantir
        setTimeout(function() {
            inicializarBotoesSair();
            inicializarBotaoConfirmarSair();
        }, 500);
        
        // ========== MODAL DE CANCELAR EVENTO ==========
        
        // Variáveis globais para o modal de cancelar evento
        window.eventoIdParaCancelar = null;
        window.eventoNomeParaCancelar = null;
        
        // Função para abrir modal de cancelar evento
        window.abrirModalCancelar = function(eventId, eventName) {
            window.eventoIdParaCancelar = eventId;
            window.eventoNomeParaCancelar = eventName;
            
            // Atualiza a mensagem do modal com o nome do evento
            const mensagem = document.getElementById('modal-cancelar-mensagem');
            if (mensagem) {
                mensagem.textContent = `Tem certeza que deseja cancelar o evento "${eventName}"? Esta ação não pode ser desfeita e todos os participantes serão notificados.`;
            }
            
            setTimeout(function() {
                const modal = document.getElementById('modal-cancelar-evento');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.classList.add('show');
                }
            }, 50);
        };
        
        // Função para fechar modal de cancelar evento
        window.fecharModalCancelar = function() {
            const modal = document.getElementById('modal-cancelar-evento');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.classList.remove('show');
            }
            window.eventoIdParaCancelar = null;
            window.eventoNomeParaCancelar = null;
        };
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-cancelar-evento');
            if (modal && event.target === modal) {
                window.fecharModalCancelar();
            }
        });
        
        // Função para inicializar botões de cancelar evento
        function inicializarBotoesCancelar() {
            const botoesCancelar = document.querySelectorAll('.btn-cancelar-evento');
            botoesCancelar.forEach((btn) => {
                // Remove listener anterior se existir
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const eventId = this.getAttribute('data-event-id');
                    const eventName = this.getAttribute('data-event-name');
                    if (window.abrirModalCancelar) {
                        window.abrirModalCancelar(eventId, eventName);
                    }
                });
            });
        }
        
        // Função para inicializar botão de confirmar cancelamento
        function inicializarBotaoConfirmarCancelar() {
            const btnConfirmarCancelar = document.getElementById('btn-confirmar-cancelar');
            if (btnConfirmarCancelar) {
                // Remove listener anterior se existir
                const newBtn = btnConfirmarCancelar.cloneNode(true);
                btnConfirmarCancelar.parentNode.replaceChild(newBtn, btnConfirmarCancelar);
                
                newBtn.addEventListener('click', function() {
                    if (!window.eventoIdParaCancelar) {
                        console.error('Evento ID não definido!');
                        return;
                    }
                    
                    // Obter CSRF token
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     document.cookie.match(/csrftoken=([^;]+)/)?.[1];
                    
                    if (!csrftoken) {
                        alert('Erro: Token de segurança não encontrado. Recarregue a página.');
                        return;
                    }
                    
                    // Fazer requisição AJAX
                    fetch(`/eventos/cancelar/${window.eventoIdParaCancelar}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({})
                    })
                    .then(async response => {
                        const responseText = await response.text();
                        let data;
                        try {
                            data = JSON.parse(responseText);
                        } catch (e) {
                            // Se não for JSON, pode ser um redirect HTML
                            if (response.ok) {
                                data = { success: true, message: 'Evento cancelado com sucesso!' };
                            } else {
                                data = { success: false, error: 'Resposta inválida do servidor' };
                            }
                        }
                        
                        if (!response.ok && !data.success) {
                            throw new Error(data.error || data.message || 'Erro ao cancelar o evento');
                        }
                        return data;
                    })
                    .then(data => {
                        console.log('Sucesso ao cancelar evento:', data);
                        // Fechar modal
                        window.fecharModalCancelar();
                        
                        // Mostrar notificação de sucesso
                        if (typeof showNotification === 'function') {
                            showNotification('Evento cancelado com sucesso!', 'success');
                        } else {
                            alert('Evento cancelado com sucesso!');
                        }
                        
                        // Recarregar a página após um pequeno delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Erro ao cancelar evento:', error);
                        alert('Erro ao cancelar evento: ' + error.message);
                    });
                });
            }
        }
        
        // Inicializar botões de cancelar evento
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                inicializarBotoesCancelar();
                inicializarBotaoConfirmarCancelar();
            });
        } else {
            inicializarBotoesCancelar();
            inicializarBotaoConfirmarCancelar();
        }
        
        // Também tenta após um pequeno delay para garantir
        setTimeout(function() {
            inicializarBotoesCancelar();
            inicializarBotaoConfirmarCancelar();
        }, 500);
    </script>
    <!-- JS para filtros via GET params se necessário -->
{% endblock %}