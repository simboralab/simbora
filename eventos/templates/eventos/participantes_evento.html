{% extends "core/page/base.html" %}
{% load static %}
{% load perfil_tags %}

{% block title %}Participantes - {{ evento.nome_evento }}{% endblock title %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'eventos/css/participantes.css' %}">
{% endblock extra_head %}

{% block content %}
    {% include "core/partials/header.html" %}
<div class="participantes-page">
    <div class="participantes-header">
        <div class="participantes-header-top">
            <div class="participantes-header-title-section">
                <div class="breadcrumb">
                    {% if request.GET.from == 'meus_eventos' %}
                        <a href="{% url 'eventos:meus_eventos' %}{% if request.GET.filtro %}?filtro={{ request.GET.filtro }}{% endif %}">
                            <span class="material-symbols-rounded">event</span>
                            Meus Eventos
                        </a>
                    {% else %}
                        <a href="{% url 'eventos:visualizar_evento' evento.id %}">
                            <span class="material-symbols-rounded">event</span>
                            Evento
                        </a>
                    {% endif %}
                    <span class="material-symbols-rounded" style="font-size: 16px;">chevron_right</span>
                    <span>Participantes</span>
                </div>
                <h1>Participantes</h1>
                <p class="evento-nome-header">{{ evento.nome_evento }}</p>
            </div>
            {% if request.GET.from == 'meus_eventos' %}
                <a href="{% url 'eventos:meus_eventos' %}{% if request.GET.filtro %}?filtro={{ request.GET.filtro }}{% endif %}" class="evento-link">
                    <span class="material-symbols-rounded">arrow_back</span>
                    Voltar
                </a>
            {% else %}
                <a href="{% url 'eventos:visualizar_evento' evento.id %}" class="evento-link">
                    <span class="material-symbols-rounded">arrow_back</span>
                    Voltar
                </a>
            {% endif %}
        </div>
    </div>
    
    <div class="participantes-stats">
        <div class="stat-item">
            <span class="material-symbols-rounded">group</span>
            <span>Total: <span class="stat-number">{{ total_participantes }}</span> participante{{ total_participantes|pluralize }}</span>
        </div>
        {% if evento.maximo_participantes %}
        <div class="stat-item">
            <span class="material-symbols-rounded">event_available</span>
            <span>Máximo: <span class="stat-number">{{ evento.maximo_participantes }}</span></span>
        </div>
        {% endif %}
    </div>
    
    {% if participantes %}
        <div class="participantes-list">
            {% for participacao in participantes %}
                {% with participante=participacao.participante %}
                <div class="participante-card">
                    {% get_avatar_url participante participante.nome_completo as avatar_url %}
                    <img src="{{ avatar_url }}" alt="{{ participante.nome_completo }}" class="participante-avatar">
                    <div class="participante-info">
                        <h3 class="participante-nome">{{ participante.nome_completo }}</h3>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            {% if evento.organizador and evento.organizador.id == participante.id %}
                                <span class="participante-badge badge-organizador">
                                    <span class="material-symbols-rounded" style="font-size: 14px;">workspace_premium</span>
                                    Organizador
                                </span>
                            {% endif %}
                            {% if participacao.status %}
                                <span class="participante-badge badge-status">
                                    <span class="material-symbols-rounded" style="font-size: 14px;">check_circle</span>
                                    {{ participacao.get_status_display }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <div class="no-participantes">
            <span class="material-symbols-rounded">group_off</span>
            <h3>Nenhum participante ainda</h3>
            <p>Este evento ainda não tem participantes confirmados.</p>
        </div>
    {% endif %}
</div>
    {% include "core/partials/footer.html" %}
{% endblock content %}

{% block extra_js %}
    {{ block.super }}
    <script>
        // Função para inicializar o menu do perfil
        function forceInitProfileMenu() {
            const trigger = document.getElementById('profile-trigger');
            const menu = document.getElementById('profile-menu');
            
            if (trigger && menu) {
                // Remove todos os listeners anteriores
                const newTrigger = trigger.cloneNode(true);
                trigger.parentNode.replaceChild(newTrigger, trigger);
                
                const newTriggerEl = document.getElementById('profile-trigger');
                const menuEl = document.getElementById('profile-menu');
                
                // Adiciona listener direto
                newTriggerEl.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuEl.classList.toggle('active');
                    newTriggerEl.classList.toggle('active');
                };
                
                // Fechar ao clicar fora
                setTimeout(function() {
                    document.addEventListener('click', function(e) {
                        if (!menuEl.contains(e.target) && !newTriggerEl.contains(e.target)) {
                            const modal = document.getElementById('modal-bora');
                            if (!modal || modal.style.display !== 'flex') {
                                menuEl.classList.remove('active');
                                newTriggerEl.classList.remove('active');
                            }
                        }
                    });
                }, 50);
                
                return true;
            }
            return false;
        }
        
        // Tenta inicializar o menu do perfil
        if (!forceInitProfileMenu()) {
            setTimeout(forceInitProfileMenu, 200);
            window.addEventListener('load', function() {
                setTimeout(forceInitProfileMenu, 100);
            });
        }
    </script>
{% endblock extra_js %}
