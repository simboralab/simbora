{% extends "core/page/base_core.html" %}

{% block title %}Editar Perfil{% endblock title %}

{% load static %}
{% load perfil_tags %}
{% block header_css %}
    <link rel="stylesheet" href="{% static 'core/css/principal.css' %}">
{% endblock header_css %}

{% block extra_head %}
       {{ block.super }}
       <link rel="stylesheet" href="{% static 'perfil/css/edit_profile.css' %}">
{% endblock extra_head %}

{% block header_include %}
    {% include "core/partials/header.html" %}
{% endblock header_include %}

{% block content %}
    <div class="container">

        <header class="header">
            <h1>Editar Perfil</h1>
        </header>

        <form class="form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="profile-photo">
                <label for="id_foto" style="cursor: pointer;">
                    {% get_avatar_url perfil user.first_name|default:user.email as profile_avatar_url %}
                    <img src="{{ profile_avatar_url }}" alt="Foto do perfil">
                </label>
                <input type="file" name="foto_perfil" id="id_foto" accept="image/*" class="hidden">
                <label for="id_foto" class="btn-alter-foto">
                    Alterar foto
                </label>
            </div>

            <h2 class="section-title">Informações Pessoais</h2>

            <label>
                Nome Social
                <input type="text" id="nome" name="nome_social" value="{{ perfil.nome_social|default:'' }}">
            </label>

            <label>
                Cidade
                <input type="text" name="cidade" value="{{ endereco.cidade|default:'' }}">
            </label>

            <label>
                Estado
                <select name="estado" id="estado">
                    <option value="">-- Selecione o Estado --</option>
                    {% for uf in ufs %}
                        <option value="{{ uf }}" {% if endereco.estado == uf %}selected{% endif %}>{{ uf }}</option>
                    {% endfor %}
                </select>

            </label>

            <label class="full-width">
                Descrição (Bio)
                <textarea name="descricao">{{ perfil.descricao|default:'' }}</textarea>
            </label>

            <h2 class="section-title">Identidade e Acessibilidade</h2>

            <label>
                Gênero
                <select name="genero">
                    <option value="">-- Selecione seu Gênero --</option>
                    {% for key, label in form.genero.field.choices %}
                        <option value="{{ key }}" {% if perfil.genero == key %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </label>

            <div class="toggle-box">
                <label class="toggle">
                    <input type="checkbox" name="is_pcd" {% if perfil.is_pcd %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <div class="toggle-text">
                    <strong>Sou uma pessoa com deficiência (PCD)</strong>
                    <p>Sinalize para que possamos sugerir eventos e locais acessíveis para você.</p>
                </div>
            </div>

            <div class="toggle-box">
                <label class="toggle">
                    <input type="checkbox" name="neurodiversidade" {% if perfil.neurodiversidade %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <div class="toggle-text">
                    <strong>Me identifico como neurodivergente</strong>
                    <p>Ajude a construir uma comunidade mais empática e a encontrar pessoas que te entendem.</p>
                </div>
            </div>

            <div class="button">
                <button type="submit" class="btn-submit" value="enviar">Salvar Alterações</button>
            </div>

        </form>

    </div>

{% endblock content %}

{% block extra_js %}
    {{ block.super }}
    <script>
        // Função para inicializar o menu do perfil
        function forceInitProfileMenu() {
            const trigger = document.getElementById('profile-trigger');
            const menu = document.getElementById('profile-menu');
            
            if (trigger && menu) {
                // Remove todos os listeners anteriores
                const newTrigger = trigger.cloneNode(true);
                trigger.parentNode.replaceChild(newTrigger, trigger);
                
                const newTriggerEl = document.getElementById('profile-trigger');
                const menuEl = document.getElementById('profile-menu');
                
                // Adiciona listener direto
                newTriggerEl.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuEl.classList.toggle('active');
                    newTriggerEl.classList.toggle('active');
                };
                
                // Fechar ao clicar fora
                setTimeout(function() {
                    document.addEventListener('click', function(e) {
                        if (!menuEl.contains(e.target) && !newTriggerEl.contains(e.target)) {
                            const modal = document.getElementById('modal-bora');
                            if (!modal || modal.style.display !== 'flex') {
                                menuEl.classList.remove('active');
                                newTriggerEl.classList.remove('active');
                            }
                        }
                    });
                }, 50);
                
                return true;
            }
            return false;
        }
        
        // Tenta inicializar o menu do perfil
        if (!forceInitProfileMenu()) {
            setTimeout(forceInitProfileMenu, 200);
            window.addEventListener('load', function() {
                setTimeout(forceInitProfileMenu, 100);
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o perfil foi salvo com sucesso
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('saved') === '1') {
                // Aguardar um pouco para garantir que showNotification está carregado
                setTimeout(function() {
                    if (typeof showNotification === 'function') {
                        showNotification('Perfil atualizado com sucesso!', 'success');
                        // Limpar o parâmetro da URL sem recarregar a página
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        console.warn('showNotification não está disponível');
                    }
                }, 100);
            }
        });
    </script>
{% endblock extra_js %}